# ASTMatcher tutorial

Refer to:https://clang.llvm.org/docs/LibASTMatchers.html

## How to create a matcher

​	With more than a thousand classes in the clang AST, one can quickly get lost when trying the figure out how to create a matcher for a specific pattern. This section will teach you how to use a rigorous  step-by-step pattern to build the matcher you are interested in. Note that there will always be matcher missing for some part of the AST. See the section about `how to write you own AST matchers` later in this document.

​	The precondition to using the matchers is to understand how the AST for what you want to match looks like. The [Introduction to the Clang AST](https://clang.llvm.org/docs/IntroductionToTheClangAST.html) teaches you how to dump a translation unit's AST into a human readable format.

​	In general, the strategy to create the right matchers is:

- Find the outermost class in Clang's AST you want to match.
- Look at the [AST Matcher Reference](https://clang.llvm.org/docs/LibASTMatchersReference.html) for matchers that either match the node you're interesting in or narrow down attributes on the node.
- Create your outer match expression. Verify that it works as expected.
- Examine the matchers for what the next inner node you want to match is.
- Repeat until the matcher is finished.

## Binding nodes in match expressions

​	Matcher expressions allow you to specify which parts of the AST are interesting for a certain task. Often you will want to then do something with the nodes that were matched, like building source code transformations.

​	To that end, matchers that match specific AST nodes (so called node matchers) are bindable; for example, 

```c++
recordDecl(hasName("MyClass")).bind("id")
```

​	The call will bind the matched recordDecl node to the string "id", to be later retrieved in the match callback.

## Writing your own matchers

​	There are multiple different ways to define a matcher, depending on its type and flexibility.

```c++
VariadicDynCastAllOfMatcher<Base, Derived>
```

​	Those match all nodes of type Base if they can be dynamically casted to Derived. The names of those matchers are nouns, which closely resemble Derived. `VariadicDynCastAllOfMatchers` are the backone of the matcher hierarchy. Most often, your match expression will start with one of them, and you can [bind](https://clang.llvm.org/docs/LibASTMatchers.html#astmatchers-bind) the node the represent to `ids` for later processing.

​	`VariadicDynCastAllOfMatchers` are callable classes that model variadic template functions in C++03. They take an aribitrary number of `Matcher<Derived>` and return a `Match<Base>`.

```c++
AST_MATCHER_P(Type, Name, ParamType, Param)
```

​	Most matcher definitions use the matcher creation macros. Thos define both the matcher of type `Matcher<Type>` itself, and a matcher-creation function named Name and takes a paramter of type ParamType and returns the corresponding matcher.

​	There are multiple matcher definition macros that deal with polymorphic return values and different parameter counts. See:[ASTMatchersMacros.h](https://clang.llvm.org/doxygen/ASTMatchersMacros_8h.html).

## Matcher creation functions

​	Matchers are generated by nesting calls to matcher creation functions. Most of the time those functions are either created by using `VariadicDynCastAllOfMatcher` of the matcher creation macros(see below). The free-standing functions are an indication that this matcher is just a combination of other matchers, as is for example the case with [callee](https://clang.llvm.org/docs/LibASTMatchersReference.html#callee1Anchor).